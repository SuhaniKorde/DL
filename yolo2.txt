import os
from ultralytics import YOLO
import cv2
from matplotlib import pyplot as plt
from pathlib import Path

yaml_text = """\
train: D:/Practical-6/data/train/images
val: D:/Practical-6/data/val/images
test: D:/Practical-6/data/test/images

nc: 4
names: ['airplane', 'car_side', 'chair', 'cup']
"""

yaml_path = r"D:\Practical-6\data.yaml"
os.makedirs(os.path.dirname(yaml_path), exist_ok=True)
with open(yaml_path, "w", encoding="utf-8") as f:
    f.write(yaml_text)
print("‚úÖ data.yaml created successfully at:", yaml_path)

dataset_root = Path(r"D:\Practical-6\data")
for cache_file in dataset_root.rglob("*.cache"):
    try:
        cache_file.unlink()
        print(f"üßπ Deleted old cache file: {cache_file}")
    except Exception as e:
        print(f"‚ö†Ô∏è Could not delete cache {cache_file}: {e}")

model = YOLO("yolov8n.pt")

model.train(
    data=yaml_path,
    epochs=5,
    imgsz=640,
    batch=8,
    cache=False,
    workers=0,
    device="cpu"
)

test_image = r"D:\Practical-6\data\test\images\image_0022.jpg"
results = model.predict(source=test_image, save=True)

output_path = results[0].save_dir / results[0].path.name
img = cv2.imread(str(output_path))
img = cv2.cvtColor(img, cv2.COLOR_BGR2RGB)
plt.figure(figsize=(8, 8))
plt.imshow(img)
plt.axis("off")
plt.title("YOLOv8 Detection Output")
plt.show()

print("üìÇ Output saved at:", results[0].save_dir)
